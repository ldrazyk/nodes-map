<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 Key-based Update with Animation</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    svg { border: 1px solid #ccc; }
  </style>
</head>
<body>
  <svg width="500" height="400"></svg>

  <script>
    const svg = d3.select("svg");
    const container = svg.append("g");

    // Initial dataset
    let nodes = [
      {id: "A", x: 100, y: 150, color: "red"},
      {id: "B", x: 200, y: 200, color: "blue"}
    ];

    function update(data) {
      // Bind data by key (id)
      let circles = container.selectAll("circle")
        .data(data, d => d.id);

      // ENTER (new elements)
      circles.enter()
        .append("circle")
        .attr("r", 20)
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("fill", d => d.color)
        .style("opacity", 0)
        .transition().duration(500)
        .style("opacity", 1);

      // UPDATE (existing elements)
      circles.transition().duration(1000)
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("fill", d => d.color);

      // EXIT (removed elements)
      circles.exit()
        .transition().duration(500)
        .style("opacity", 0)
        .remove();
    }

    // Draw initial state
    update(nodes);

    // Every 2 seconds, change data
    setInterval(() => {
      nodes = [
        {id: "A", x: 100 + Math.random()*200, y: 100 + Math.random()*200, color: "red"},
        {id: "B", x: 100 + Math.random()*200, y: 100 + Math.random()*200, color: "blue"},
        {id: "C", x: 100 + Math.random()*200, y: 100 + Math.random()*200, color: "green"} // sometimes new
      ].slice(0, Math.floor(Math.random()*3)+1); // randomly drop some

      update(nodes);
    }, 2000);

    // Add zoom/pan behavior
    const zoom = d3.zoom()
      .scaleExtent([0.5, 10]) // min and max zoom
      .on("zoom", (event) => {
        container.attr("transform", event.transform);
      });

    svg.call(zoom);

  </script>
</body>
</html>
